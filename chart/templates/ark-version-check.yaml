{{- if .Values.ark.supportedVersions }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Values.app.name }}-ark-version-check
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: 0
  template:
    metadata:
      name: {{ .Values.app.name }}-ark-version-check
    spec:
      restartPolicy: Never
      serviceAccountName: {{ .Values.app.name }}-version-check
      containers:
      - name: ark-version-check
        image: alpine/helm:latest
        command:
        - sh
        - -c
        - |
          set -e
          echo "Checking ARK controller version via Helm..."

          # Get ARK controller version from Helm release
          VERSION=$(helm list -A -o json | grep -A20 '"name":"ark-controller"' | grep '"app_version"' | head -1 | cut -d'"' -f4 || echo "")

          if [ -z "$VERSION" ]; then
            echo "ERROR: Could not find ARK controller Helm release"
            echo "Please ensure ARK is installed via: ark install"
            echo "Expected to find 'ark-controller' release in 'ark-system' namespace"
            exit 1
          fi

          echo "ARK controller version: $VERSION"
          echo "Required version: {{ .Values.ark.supportedVersions }}"

          # Parse version requirements (supports: >=X.Y.Z <A.B.C format)
          REQUIRED="{{ .Values.ark.supportedVersions }}"

          # Extract min and max versions from range
          MIN_VER=$(echo "$REQUIRED" | sed -n 's/.*>=\([0-9.]*\).*/\1/p')
          MAX_VER=$(echo "$REQUIRED" | sed -n 's/.*<\([0-9.]*\).*/\1/p')

          # Compare versions using sort -V (version sort)
          check_version() {
            [ "$1" = "$(echo -e "$1\n$2" | sort -V | head -n1)" ]
          }

          # Check minimum version if specified
          if [ -n "$MIN_VER" ]; then
            if ! check_version "$MIN_VER" "$VERSION"; then
              echo "ERROR: ARK controller version $VERSION is below minimum required version $MIN_VER"
              echo "Please upgrade ARK to version $MIN_VER or higher"
              exit 1
            fi
          fi

          # Check maximum version if specified
          if [ -n "$MAX_VER" ]; then
            if ! check_version "$VERSION" "$MAX_VER"; then
              echo "ERROR: ARK controller version $VERSION is above maximum supported version $MAX_VER"
              echo "This version of ark-n8n supports ARK versions up to $MAX_VER"
              exit 1
            fi
          fi

          echo "âœ“ ARK controller version $VERSION is compatible with ark-n8n"
{{- end }}
