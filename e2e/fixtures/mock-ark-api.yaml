apiVersion: v1
kind: Namespace
metadata:
  name: ark-system
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mock-ark-responses
  namespace: ark-system
data:
  agents.json: |
    {
      "items": [
        {
          "metadata": {
            "name": "test-agent",
            "namespace": "default"
          },
          "spec": {
            "modelRef": {
              "name": "gpt-4",
              "namespace": "default"
            },
            "prompt": "You are a helpful test agent."
          }
        }
      ]
    }
  models.json: |
    {
      "items": [
        {
          "metadata": {
            "name": "gpt-4",
            "namespace": "default"
          },
          "spec": {
            "provider": "openai",
            "model": "gpt-4"
          }
        }
      ]
    }
  teams.json: |
    {
      "items": [
        {
          "metadata": {
            "name": "test-team",
            "namespace": "default"
          },
          "spec": {
            "agents": ["test-agent"]
          }
        }
      ]
    }
  evaluators.json: |
    {
      "items": [
        {
          "metadata": {
            "name": "test-evaluator",
            "namespace": "default"
          },
          "spec": {
            "dimensions": ["accuracy", "relevance"]
          }
        }
      ]
    }
  memories.json: |
    {
      "items": [
        {
          "metadata": {
            "name": "test-memory",
            "namespace": "default"
          },
          "spec": {
            "type": "buffer",
            "maxMessages": 20
          }
        }
      ]
    }
  query-response.json: |
    {
      "metadata": {
        "name": "test-query-123",
        "namespace": "default"
      },
      "spec": {
        "input": "Test question",
        "targets": [{"type": "agent", "name": "test-agent"}],
        "wait": true
      },
      "status": {
        "state": "completed",
        "response": "This is a test response from the mock ARK API.",
        "completedAt": "2024-01-01T00:00:00Z"
      }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mock-ark-api
  namespace: ark-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mock-ark-api
  template:
    metadata:
      labels:
        app: mock-ark-api
    spec:
      containers:
      - name: mock-api
        image: python:3.11-slim
        ports:
        - containerPort: 8000
        command:
        - /bin/bash
        - -c
        - |
          cat > /app/server.py << 'EOF'
          from http.server import HTTPServer, BaseHTTPRequestHandler
          import json
          import os

          class MockARKHandler(BaseHTTPRequestHandler):
              def do_GET(self):
                  if '/v1/namespaces/default/agents' in self.path:
                      self.send_json(self.read_fixture('agents.json'))
                  elif '/v1/namespaces/default/models' in self.path:
                      self.send_json(self.read_fixture('models.json'))
                  elif '/v1/namespaces/default/teams' in self.path:
                      self.send_json(self.read_fixture('teams.json'))
                  elif '/v1/namespaces/default/evaluators' in self.path:
                      self.send_json(self.read_fixture('evaluators.json'))
                  elif '/v1/namespaces/default/memories' in self.path:
                      self.send_json(self.read_fixture('memories.json'))
                  elif '/health' in self.path:
                      self.send_json({'status': 'healthy'})
                  else:
                      self.send_error(404)

              def do_POST(self):
                  if '/v1/namespaces/default/queries' in self.path:
                      # Read request body
                      content_length = int(self.headers['Content-Length'])
                      body = self.rfile.read(content_length)

                      # Return query response
                      self.send_json(self.read_fixture('query-response.json'))
                  else:
                      self.send_error(404)

              def do_PATCH(self):
                  # Mock PATCH for agent updates
                  self.send_response(200)
                  self.send_header('Content-Type', 'application/json')
                  self.end_headers()
                  self.wfile.write(b'{"status": "updated"}')

              def send_json(self, data):
                  self.send_response(200)
                  self.send_header('Content-Type', 'application/json')
                  self.end_headers()
                  if isinstance(data, str):
                      self.wfile.write(data.encode())
                  else:
                      self.wfile.write(json.dumps(data).encode())

              def read_fixture(self, filename):
                  path = f'/fixtures/{filename}'
                  if os.path.exists(path):
                      with open(path, 'r') as f:
                          return f.read()
                  return '{}'

              def log_message(self, format, *args):
                  # Simple logging
                  print(f"{self.client_address[0]} - {format % args}")

          if __name__ == '__main__':
              server = HTTPServer(('0.0.0.0', 8000), MockARKHandler)
              print('Mock ARK API running on port 8000')
              server.serve_forever()
          EOF

          python /app/server.py
        volumeMounts:
        - name: fixtures
          mountPath: /fixtures
      volumes:
      - name: fixtures
        configMap:
          name: mock-ark-responses
---
apiVersion: v1
kind: Service
metadata:
  name: mock-ark-api
  namespace: ark-system
spec:
  selector:
    app: mock-ark-api
  ports:
  - port: 8000
    targetPort: 8000
