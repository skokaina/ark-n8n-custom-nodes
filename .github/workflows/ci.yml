name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  packages: read

jobs:
  # Step 1: Quality checks (run in parallel)
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "npm"
          cache-dependency-path: nodes/package-lock.json

      - name: Install dependencies
        run: |
          cd nodes
          npm ci

      - name: Run ESLint
        run: |
          cd nodes
          npm run lint

      - name: TypeScript compilation check
        run: |
          cd nodes
          npx tsc --noEmit

  test:
    name: Unit Tests & Coverage
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "npm"
          cache-dependency-path: nodes/package-lock.json

      - name: Install dependencies
        run: |
          cd nodes
          npm ci

      - name: Run tests with coverage
        run: |
          cd nodes
          npm run test:coverage

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: nodes/coverage/
          retention-days: 7

      - name: Check coverage threshold
        if: success()
        run: |
          cd nodes
          if [ ! -f coverage/coverage-summary.json ]; then
            echo "Error: coverage-summary.json not found"
            exit 1
          fi
          COVERAGE=$(node -pe "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json')).total.lines.pct")
          echo "Coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "Coverage below 80% threshold"
            exit 1
          fi

  # Step 2: Build (only if lint + test pass)
  build:
    name: Build Nodes & Docker Image
    runs-on: ubuntu-24.04
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "npm"
          cache-dependency-path: nodes/package-lock.json

      - name: Build custom nodes
        run: |
          cd nodes
          npm ci
          npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nodes-dist
          path: nodes/dist/
          retention-days: 1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          push: false
          tags: ark-n8n:ci-test
          cache-from: |
            type=gha
          cache-to: |
            type=gha,mode=max

  # Step 3: E2E Tests (on main branch and PRs to main, only if build passes)
  e2e:
    name: E2E Tests
    runs-on: ubuntu-24.04
    needs: [build]
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'main')
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "npm"
          cache-dependency-path: |
            nodes/package-lock.json
            e2e/package-lock.json

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: nodes-dist
          path: nodes/dist/

      - name: Install k3d
        run: |
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

      - name: Create k3d cluster
        run: |
          k3d cluster create ark-test \
            --agents 2 \
            --port "5678:5678@loadbalancer" \
            --wait \
            --timeout 5m

      - name: Verify cluster
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Install ARK CLI
        run: |
          npm install -g @agents-at-scale/ark@0.1.51 || npm install -g @agents-at-scale/ark
          ark --version

      - name: Install ARK to cluster
        run: |
          ark install --yes --wait-for-ready 5m --verbose
          echo "✓ ARK installed successfully"
          kubectl get pods -n ark-system
          kubectl get svc -n ark-system

      - name: Wait for ARK webhook service
        run: |
          echo "Waiting for ARK webhook to be ready..."

          # Wait for webhook configuration to exist
          echo "Checking for webhook configuration..."
          for i in {1..60}; do
            if kubectl get validatingwebhookconfigurations.admissionregistration.k8s.io 2>/dev/null | grep -q ark; then
              echo "✓ Webhook configuration found"
              break
            fi
            echo "Waiting for webhook configuration... ($i/60)"
            sleep 2
          done

          # Wait for ark-webhook-service to be accessible
          echo "Checking for webhook service..."
          kubectl get svc -n ark-system

          # Give webhook extra time to warm up (it's part of controller or separate pod)
          echo "Waiting 30s for webhook to become fully responsive..."
          sleep 30

          # Verify webhook endpoints exist
          kubectl get endpoints -n ark-system | grep webhook || echo "Note: No separate webhook endpoint (may be part of controller)"

      - name: Setup Free API and ARK test resources
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          # Create Groq API secret (free, no credit card required)
          # Get your key at: https://console.groq.com/keys
          kubectl create secret generic groq-api-key \
            --from-literal=api-key="$GROQ_API_KEY"

          # Temporarily disable webhook validation for initial setup
          # The webhook service needs significant warmup time and causes 502 errors initially
          echo "Temporarily removing webhook validation for resource creation..."
          kubectl delete validatingwebhookconfigurations.admissionregistration.k8s.io ark-validating-webhook-configuration || true
          kubectl delete mutatingwebhookconfigurations.admissionregistration.k8s.io ark-mutating-webhook-configuration || true

          # Apply resources without webhook validation
          echo "Creating ARK resources (webhook validation disabled for initial setup)..."
          kubectl apply -f e2e/fixtures/ark-free-api-resources.yaml

          # Wait for controller to process resources
          sleep 10

          # Re-enable webhook validation (ARK will recreate it)
          echo "Waiting for ARK to recreate webhook configuration..."
          sleep 5

          kubectl get agents,models,teams,memories,evaluators -n default
          echo "✓ Free API and ARK resources ready (Groq - llama-3.1-8b-instant)"

      - name: Build Docker image
        run: |
          docker build -t ark-n8n:test .

      - name: Load image into k3d
        run: |
          k3d image import ark-n8n:test -c ark-test

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: "3.14.0"

      - name: Install ark-n8n via Helm
        run: |
          helm install ark-n8n ./chart \
            -f chart/values-testing.yaml \
            --set app.image.repository=ark-n8n \
            --set app.image.tag=test \
            --set app.image.pullPolicy=Never \
            --set ark.apiUrl=http://ark-api.default.svc.cluster.local \
            --wait \
            --timeout 5m

      - name: Wait for n8n to be ready
        run: |
          kubectl wait --for=condition=available --timeout=300s deployment/ark-n8n
          echo "✓ n8n deployment ready"

          kubectl wait --for=condition=available --timeout=120s deployment/ark-n8n-nginx
          echo "✓ nginx proxy deployment ready"

          kubectl get pods

          echo "=== n8n environment variables ==="
          kubectl exec deployment/ark-n8n -- env | grep -E "N8N_USER_MANAGEMENT|N8N_BASIC_AUTH|N8N_PERSONALIZATION" || echo "Auth env vars not found!"

          kubectl logs deployment/ark-n8n --tail=50

      - name: Install Playwright
        run: |
          cd e2e
          npm ci
          npx playwright install --with-deps chromium

      - name: Verify backend n8n service
        run: |
          echo "=== n8n Service ==="
          kubectl get svc ark-n8n

          echo -e "\n=== Test n8n connectivity from nginx pod ==="
          kubectl exec deployment/ark-n8n-nginx -- curl -I http://ark-n8n:5678 || echo "❌ Nginx cannot reach n8n service"

          echo -e "\n=== Test n8n directly from cluster ==="
          kubectl run curl-test --image=curlimages/curl:latest --rm -i --restart=Never -- \
            curl -I http://ark-n8n:5678

      - name: Port forward nginx proxy with auto-login
        run: |
          # Verify nginx pod is actually running
          kubectl get pods -l app.kubernetes.io/component=proxy
          kubectl logs deployment/ark-n8n-nginx --tail=20

          # Start port forward in background (port 8080 matches N8N_HOST configuration)
          kubectl port-forward svc/ark-n8n-proxy 8080:80 > /dev/null 2>&1 &
          sleep 10

          # Test connectivity with retries
          curl --retry 15 --retry-delay 3 --retry-connrefused --retry-all-errors http://localhost:8080
          echo "✓ n8n accessible via auto-login proxy at http://localhost:8080"

      - name: Debug on port-forward failure
        if: failure()
        run: |
          echo "=== Nginx error logs ==="
          kubectl logs deployment/ark-n8n-nginx | grep -i error || echo "No errors in nginx logs"

          echo -e "\n=== Nginx access logs ==="
          kubectl logs deployment/ark-n8n-nginx --tail=50

          echo -e "\n=== Port-forward processes ==="
          ps aux | grep "port-forward" || true

      - name: Run Playwright tests
        run: |
          cd e2e
          npx playwright test

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            e2e/playwright-report/
            e2e/test-results/
          retention-days: 7

      - name: Debug on failure
        if: failure()
        run: |
          echo "=== Pods ==="
          kubectl get pods -A

          echo "=== n8n init container logs ==="
          kubectl logs -l app=ark-n8n -c ark-version-check --tail=100 || echo "Init container not found"

          echo "=== n8n main container logs ==="
          kubectl logs deployment/ark-n8n --tail=100 || echo "Main container not started yet"

          echo "=== n8n pod description ==="
          kubectl describe pod -l app=ark-n8n | tail -50

          echo "=== ARK API accessibility test ==="
          kubectl run curl-test --image=curlimages/curl:latest --rm -i --restart=Never -- \
            curl -v http://ark-api.default.svc.cluster.local/v1/version || echo "ARK API not reachable"

          echo "=== ARK Controller logs ==="
          kubectl logs deployment/ark-controller -n ark-system --tail=100

          echo "=== ARK Queries ==="
          kubectl get queries -n default || echo "No queries found"

      - name: Cleanup
        if: always()
        run: |
          k3d cluster delete ark-test
