name: Helm Chart

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.0)'
        required: true
        type: string
  push:
    tags:
      - "v*"

permissions:
  contents: read
  packages: write

jobs:
  publish:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: "3.14.0"

      - name: Extract version from tag or input
        id: version
        run: |
          if [[ -n "${{ inputs.version }}" ]]; then
            # Called via workflow_call with version input
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Triggered by tag push
            VERSION=${GITHUB_REF#refs/tags/}
            echo "version=${VERSION#v}" >> $GITHUB_OUTPUT
          else
            # Manual dispatch or other trigger
            echo "version=0.0.0-dev" >> $GITHUB_OUTPUT
          fi

      - name: Update Chart.yaml version
        run: |
          sed -i "s/^version:.*/version: ${{ steps.version.outputs.version }}/" chart/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: ${{ steps.version.outputs.version }}/" chart/Chart.yaml

      - name: Package Helm chart
        run: |
          helm package chart/

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Push Helm chart to OCI registry
        run: |
          helm push ark-n8n-${{ steps.version.outputs.version }}.tgz oci://ghcr.io/${{ github.repository_owner }}/charts
